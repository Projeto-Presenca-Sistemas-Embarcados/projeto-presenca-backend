# Documenta√ß√£o da API - Sistema de Presen√ßa

## üìã √çndice

- [Autentica√ß√£o JWT](#-autentica√ß√£o-jwt)
- [Valida√ß√£o de Campos](#-valida√ß√£o-de-campos)
- [Isolamento por Professor](#-isolamento-por-professor)
- [Endpoints da API](#-endpoints-da-api)
- [C√≥digos de Erro](#-c√≥digos-de-erro)
- [Exemplos de Uso](#-exemplos-de-uso)

---

## üîê Autentica√ß√£o JWT

### Funcionalidades

- **Login/Logout** com tokens de acesso (15 min) e refresh (7 dias)
- **Registro** de novos professores
- **Hash de senhas** com bcrypt
- **Middleware de autentica√ß√£o** para proteger rotas
- **Valida√ß√£o de for√ßa de senha**
- **Altera√ß√£o de senha** com invalida√ß√£o de tokens

### Endpoints de Autentica√ß√£o

#### 1. Registro de Professor

```bash
POST /auth/register
```

**Body:**

```json
{
  "name": "Jo√£o Silva",
  "email": "joao@exemplo.com",
  "password": "MinhaSenh@123",
  "tagId": "TAG001"
}
```

#### 2. Login

```bash
POST /auth/login
```

**Body:**

```json
{
  "email": "joao@exemplo.com",
  "password": "MinhaSenh@123"
}
```

#### 3. Renovar Token

```bash
POST /auth/refresh
```

**Body:**

```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### 4. Alterar Senha

```bash
POST /auth/change-password
```

**Headers:** `Authorization: Bearer <token>`
**Body:**

```json
{
  "currentPassword": "MinhaSenh@123",
  "newPassword": "NovaSenh@456"
}
```

### Crit√©rios de Senha

- M√≠nimo 8 caracteres
- Pelo menos 1 letra mai√∫scula
- Pelo menos 1 letra min√∫scula
- Pelo menos 1 n√∫mero
- Pelo menos 1 caractere especial

---

## ‚úÖ Valida√ß√£o de Campos

### Tipos de Valida√ß√£o

1. **Campos Obrigat√≥rios** - Verifica se todos os campos necess√°rios est√£o presentes
2. **Tipos de Dados** - Valida se os campos t√™m os tipos corretos (string, number, boolean, email)
3. **Comprimento de Strings** - Valida comprimento m√≠nimo e m√°ximo
4. **Formato de Email** - Valida se o email est√° em formato v√°lido

### Estrutura de Resposta de Erro

```json
{
  "error": "Dados inv√°lidos",
  "code": "VALIDATION_ERROR",
  "details": [
    {
      "field": "nomeDoCampo",
      "message": "Descri√ß√£o do erro",
      "code": "CODIGO_DO_ERRO"
    }
  ]
}
```

### Exemplos de Valida√ß√£o

#### Registro com Campos Faltando

```bash
curl -X POST http://localhost:3000/auth/register \
  -H "Content-Type: application/json" \
  -d '{"name": "Teste", "email": "teste@exemplo.com"}'
```

**Resposta:**

```json
{
  "error": "Dados inv√°lidos",
  "code": "VALIDATION_ERROR",
  "details": [
    {
      "field": "password",
      "message": "Campo 'password' √© obrigat√≥rio",
      "code": "REQUIRED_FIELD_MISSING"
    },
    {
      "field": "tagId",
      "message": "Campo 'tagId' √© obrigat√≥rio",
      "code": "REQUIRED_FIELD_MISSING"
    }
  ]
}
```

#### Email Inv√°lido

```json
{
  "error": "Dados inv√°lidos",
  "code": "VALIDATION_ERROR",
  "details": [
    {
      "field": "email",
      "message": "Campo 'email' deve ser um email v√°lido",
      "code": "INVALID_EMAIL_FORMAT"
    }
  ]
}
```

---

## üõ°Ô∏è Isolamento por Professor

### Funcionalidades de Seguran√ßa

- **Filtro Autom√°tico** - Cada professor v√™ apenas suas pr√≥prias aulas
- **Cria√ß√£o Autom√°tica** - Li√ß√µes s√£o automaticamente associadas ao professor autenticado
- **Controle de Acesso** - Verifica√ß√£o rigorosa de permiss√µes em todas as opera√ß√µes

### Como Funciona

O sistema usa o token JWT para identificar o professor e:

- Filtra automaticamente as consultas por `teacherId`
- Verifica permiss√µes antes de qualquer opera√ß√£o
- Associa automaticamente novos recursos ao professor correto
- Retorna erros claros para tentativas de acesso n√£o autorizado

### Exemplo de Isolamento

#### Professor A cria uma li√ß√£o:

```bash
curl -X POST http://localhost:3000/lessons \
  -H "Authorization: Bearer <token_professor_A>" \
  -H "Content-Type: application/json" \
  -d '{
    "room": "A101",
    "subject": "Matem√°tica",
    "startTime": "2024-01-01T08:00:00Z",
    "endTime": "2024-01-01T10:00:00Z"
  }'
```

#### Professor B tenta acessar a li√ß√£o do Professor A:

```bash
curl -X GET http://localhost:3000/lessons/1 \
  -H "Authorization: Bearer <token_professor_B>"
```

**Resposta de Erro:**

```json
{
  "error": "Voc√™ s√≥ pode acessar suas pr√≥prias aulas",
  "code": "FORBIDDEN_ACCESS"
}
```

---

## üöÄ Endpoints da API

### Autentica√ß√£o

| M√©todo | Endpoint                | Descri√ß√£o           | Autentica√ß√£o |
| ------ | ----------------------- | ------------------- | ------------ |
| POST   | `/auth/register`        | Registrar professor | ‚ùå           |
| POST   | `/auth/login`           | Fazer login         | ‚ùå           |
| POST   | `/auth/refresh`         | Renovar token       | ‚ùå           |
| POST   | `/auth/logout`          | Fazer logout        | ‚úÖ           |
| POST   | `/auth/change-password` | Alterar senha       | ‚úÖ           |

### Professores

| M√©todo | Endpoint        | Descri√ß√£o                  | Autentica√ß√£o |
| ------ | --------------- | -------------------------- | ------------ |
| GET    | `/teachers`     | Listar professores         | ‚úÖ           |
| POST   | `/teachers`     | Criar professor            | ‚úÖ           |
| GET    | `/teachers/:id` | Obter professor espec√≠fico | ‚úÖ           |

### Estudantes

| M√©todo | Endpoint               | Descri√ß√£o                  | Autentica√ß√£o |
| ------ | ---------------------- | -------------------------- | ------------ |
| GET    | `/students`            | Listar estudantes          | ‚úÖ           |
| POST   | `/students`            | Criar estudante            | ‚úÖ           |
| GET    | `/students/:id`        | Obter estudante espec√≠fico | ‚úÖ           |
| GET    | `/students/tag/:tagId` | Buscar por tag (RFID/NFC)  | ‚ùå           |

### Li√ß√µes

| M√©todo | Endpoint                      | Descri√ß√£o                  | Autentica√ß√£o |
| ------ | ----------------------------- | -------------------------- | ------------ |
| GET    | `/lessons`                    | Listar li√ß√µes do professor | ‚úÖ           |
| POST   | `/lessons`                    | Criar li√ß√£o                | ‚úÖ           |
| GET    | `/lessons/:id`                | Obter li√ß√£o espec√≠fica     | ‚úÖ           |
| GET    | `/lessons/teacher/:teacherId` | Li√ß√µes de um professor     | ‚úÖ           |
| POST   | `/lessons/:id/open`           | Abrir li√ß√£o                | ‚úÖ           |
| POST   | `/lessons/:id/close`          | Fechar li√ß√£o               | ‚úÖ           |
| GET    | `/lessons/:id/students`       | Alunos de uma li√ß√£o        | ‚úÖ           |
| POST   | `/lessons/:id/attendance`     | Marcar presen√ßa            | ‚úÖ           |

---

## ‚ùå C√≥digos de Erro

### Autentica√ß√£o

| C√≥digo                     | Descri√ß√£o                     |
| -------------------------- | ----------------------------- |
| `MISSING_CREDENTIALS`      | Email ou senha n√£o fornecidos |
| `INVALID_CREDENTIALS`      | Email ou senha inv√°lidos      |
| `MISSING_TOKEN`            | Token n√£o fornecido           |
| `INVALID_TOKEN`            | Token inv√°lido ou expirado    |
| `USER_NOT_FOUND`           | Usu√°rio n√£o encontrado        |
| `TOKEN_INVALIDATED`        | Token foi invalidado          |
| `AUTHENTICATION_REQUIRED`  | Autentica√ß√£o necess√°ria       |
| `INSUFFICIENT_PERMISSIONS` | Permiss√µes insuficientes      |

### Valida√ß√£o

| C√≥digo                   | Descri√ß√£o                       |
| ------------------------ | ------------------------------- |
| `VALIDATION_ERROR`       | Dados inv√°lidos                 |
| `REQUIRED_FIELD_MISSING` | Campo obrigat√≥rio n√£o fornecido |
| `INVALID_FIELD_TYPE`     | Tipo de campo incorreto         |
| `INVALID_EMAIL_FORMAT`   | Formato de email inv√°lido       |
| `FIELD_TOO_SHORT`        | Campo muito curto               |
| `FIELD_TOO_LONG`         | Campo muito longo               |
| `WEAK_PASSWORD`          | Senha n√£o atende aos crit√©rios  |

### Neg√≥cio

| C√≥digo                 | Descri√ß√£o                                       |
| ---------------------- | ----------------------------------------------- |
| `EMAIL_ALREADY_EXISTS` | Email j√° est√° em uso                            |
| `TAG_ALREADY_EXISTS`   | Tag ID j√° est√° em uso                           |
| `FORBIDDEN_ACCESS`     | Tentativa de acessar recurso de outro professor |
| `LESSON_NOT_FOUND`     | Aula n√£o encontrada                             |
| `LESSON_NOT_OPEN`      | Aula n√£o est√° aberta                            |
| `STUDENT_NOT_FOUND`    | Estudante n√£o encontrado                        |
| `TEACHER_NOT_FOUND`    | Professor n√£o encontrado                        |

---

## üìù Exemplos de Uso

### 1. Fluxo Completo de Autentica√ß√£o

```bash
# 1. Registrar professor
curl -X POST http://localhost:3000/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Jo√£o Silva",
    "email": "joao@exemplo.com",
    "password": "MinhaSenh@123",
    "tagId": "TAG001"
  }'

# 2. Fazer login
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "joao@exemplo.com",
    "password": "MinhaSenh@123"
  }'

# 3. Usar token em requisi√ß√µes
curl -X GET http://localhost:3000/lessons \
  -H "Authorization: Bearer <access_token>"
```

### 2. Gerenciamento de Li√ß√µes

```bash
# Criar li√ß√£o
curl -X POST http://localhost:3000/lessons \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "room": "A101",
    "subject": "Matem√°tica",
    "startTime": "2024-01-01T08:00:00Z",
    "endTime": "2024-01-01T10:00:00Z"
  }'

# Abrir li√ß√£o para presen√ßa
curl -X POST http://localhost:3000/lessons/1/open \
  -H "Authorization: Bearer <token>"

# Marcar presen√ßa
curl -X POST http://localhost:3000/lessons/1/attendance \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "studentId": 1,
    "present": true
  }'

# Fechar li√ß√£o
curl -X POST http://localhost:3000/lessons/1/close \
  -H "Authorization: Bearer <token>"
```

### 3. Gerenciamento de Estudantes

```bash
# Criar estudante
curl -X POST http://localhost:3000/students \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Maria Santos",
    "tagId": "STUDENT001"
  }'

# Buscar estudante por tag (RFID/NFC)
curl -X GET http://localhost:3000/students/tag/STUDENT001
```

---

## ‚öôÔ∏è Configura√ß√£o

### Vari√°veis de Ambiente

Crie um arquivo `.env` na raiz do projeto:

```env
# JWT Secrets (altere em produ√ß√£o)
JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-in-production

# Database
DATABASE_URL="file:./prisma/data.db"
```

### Seguran√ßa

1. **Altere as chaves JWT** em produ√ß√£o
2. **Use HTTPS** em produ√ß√£o
3. **Configure CORS** adequadamente
4. **Monitore tentativas de login** suspeitas
5. **Implemente rate limiting** se necess√°rio

---

## üîÑ Tempo de Expira√ß√£o dos Tokens

- **Access Token**: 15 minutos
- **Refresh Token**: 7 dias

Os tokens s√£o automaticamente renovados quando necess√°rio usando o refresh token.

---

## üìä Resumo das Funcionalidades

### ‚úÖ Implementado

- [x] Autentica√ß√£o JWT completa
- [x] Valida√ß√£o robusta de campos
- [x] Isolamento por professor
- [x] Hash de senhas com bcrypt
- [x] Middleware de autentica√ß√£o
- [x] Controle de acesso granular
- [x] Tratamento de erros padronizado
- [x] Documenta√ß√£o completa

### üéØ Benef√≠cios

- **Seguran√ßa**: Sistema robusto com isolamento de dados
- **Usabilidade**: Valida√ß√£o clara e mensagens de erro espec√≠ficas
- **Manutenibilidade**: C√≥digo organizado e bem documentado
- **Escalabilidade**: Arquitetura preparada para crescimento
- **Auditoria**: Rastreamento completo de opera√ß√µes

---

_Documenta√ß√£o atualizada em: 21/09/2025_
